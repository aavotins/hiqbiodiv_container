Bootstrap: docker
From: rocker/geospatial:4.5.1

%environment
    # Runtime environment variables
    export PATH="/usr/local/bin/whitebox_tools:$PATH"
    export R_ENVIRON_USER=/etc/R/Renviron.site
    export DEBIAN_FRONTEND=noninteractive

%post
    ##############################
    # Base system preparation
    ##############################
    apt-get update && apt-get install -y --no-install-recommends \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libgit2-dev \
        libgdal-dev \
        libgeos-dev \
        libproj-dev \
        libudunits2-dev \
        libv8-dev \
        libglpk-dev \
        libxt-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        libfontconfig1-dev \
        libfreetype6-dev \
        libpng-dev \
        libtiff5-dev \
        libjpeg-dev \
        libopenblas-dev \
        unzip \
        wget \
        curl \
        ca-certificates \
        fonts-dejavu-core

    apt-get clean && rm -rf /var/lib/apt/lists/*

    ##############################
    # Install WhiteboxTools binary (Linux AMD64)
    ##############################
    mkdir -p /usr/local/bin/whitebox_tools
    wget https://github.com/jblindsay/whitebox-tools/releases/download/v2.3.0/whitebox_tools_linux_amd64.zip \
         -O /tmp/wbt.zip \
    && unzip /tmp/wbt.zip -d /usr/local/bin/whitebox_tools \
    && chmod +x /usr/local/bin/whitebox_tools/whitebox_tools \
    && ln -s /usr/local/bin/whitebox_tools/whitebox_tools /usr/local/bin/wbt

    ##############################
    # Install CRAN packages
    ##############################
    Rscript -e "install.packages('remotes', repos='https://cloud.r-project.org')"

    Rscript -e "install.packages(c(
      'sf', 'tidyverse', 'arrow', 'sfarrow', 'terra', 'readxl', 'openxlsx',
      'patchwork', 'usdm', 'maps', 'maxnet', 'ecospat', 'plotROC', 'rasterVis',
      'SDMtune', 'ENMeval', 'zeallot', 'ggview', 'scales', 'ggthemes', 'ggtext',
      'raster', 'fasterize', 'gdalUtilities', 'exactextractr', 'whitebox',
      'landscapemetrics', 'httr', 'ows4R', 'doParallel', 'foreach'
    ), dependencies = TRUE, repos = 'https://cloud.r-project.org')"

    ##############################
    # Install GitHub package: egvtools
    ##############################
    Rscript -e "remotes::install_github('aavotins/egvtools')"

    ##############################
    # Initialize WhiteboxTools (optional, helps cache path)
    ##############################
    Rscript -e "whitebox::wbt_init(exe_path = '/usr/local/bin/whitebox_tools/whitebox_tools')"

    ##############################
    # Clean up
    ##############################
    rm -rf /tmp/* /var/tmp/*

%runscript
    exec R "$@"

%help
    This is a reproducible container for EGV workflows.
    Includes:
      - Rocker geospatial 4.5.1 as base
      - All R packages used for EGV creation, including egvtools GitHub package
      - WhiteboxTools binary (v2.3.0) + R wrapper preconfigured

    Run with:
        singularity exec container.sif Rscript script.R
